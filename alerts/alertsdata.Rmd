data-quality code
========================================================

### Install `alm` if not installed already, then load package

```{r}
# install.packages('stringr')
# devtools::install_github("ropensci/alm", ref="dev")
library('stringr')
library('alm')
```

### Credentials

You need to give credentials to get alerts data. Do one of:

* execute `options(almv4_user='<your user name>')` and `options(almv4_pwd='<your password>')`, or
* pass in directly to the `alm_alerts()` function, or
* store in your `.Rprofile` file as `options(almv4_user='<your user name>')` and `options(almv4_pwd='<your password>')`

### Get alerts data


```{r}
# Possible alerts types
alert_types()

# Search for alm alerts
almdat <- alm_alerts(class_name = "EventCountIncreasingTooFastError")
dat <- almdat$data
head(dat)
parse_alert_mssg <- function(x, class){
  ms <- x$message
  foo <- function(x){
    tt <- data.frame(do.call(rbind, str_extract_all(x, "[0-9]+")))
    names(tt) <- c('high','low')
    tt
  }
  bar <- function(y) as.numeric(vapply(y, str_extract, character(1), pattern="[0-9]+", USE.NAMES = FALSE))
  
  tmp <- switch(class, 
    HtmlRatioTooHighError = data.frame(ratio=as.numeric(str_extract(ms, "[0-9]+\\.?[0-9]+"))),
    EventCountDecreasingError = foo(ms),
    EventCountIncreasingTooFastError = bar(ms),
    ArticleNotUpdatedError = bar(ms),
    `Net::HTTPRequestTimeOut` = NA,
    `Delayed::WorkerTimeout` = NA,
    DelayedJobError = NA,
    `Net::HTTPConflict` = NA,
    `Net::HTTPUnauthorized` = NA,
    `Net::HTTPRequestTimeOut` = NA,
    `Delayed::WorkerTimeout` = NA,
    `Net::HTTPServiceUnavailable` = NA,
    `Faraday::ResourceNotFound` = NA,
    `ActiveRecord::RecordInvalid` = NA,
    TooManyErrorsBySourceError = NA,
    `SourceInactiveError` = NA,
    `TooManyWorkersError` = NA,
    ApiResponseTooSlowError = NA,
    CitationMilestoneAlert = NA
  )
  cbind(x, tmp)
}
dat <- parse_alert_mssg(x=dat, class="EventCountIncreasingTooFastError")
head(dat)
```

### Get more alm data on dois from alerts data

```{r}
(dois <- dat$doi)
almdata <- alm(dois)
names(almdata) <- dois
```
