Workflow for detecting and exploring just outliers
========================================================



### Date 

Compiled on 2014-10-31 17:54:39

### Setup

> change directory to /data-quality/alerts/


Install `alm` if not installed already, then load package


```r
# source functions
source("helper_fxns.R")

# install.packages('stringr')
# devtools::install_github("ropensci/alm", ref="dev")
library('stringr')
library('alm')
library('plyr')
library('dplyr')
library('tidyr')
library('assertthat')
library('ggplot2')
library('lubridate')
library('knitr')
```



### Get alerts data by alert class

#### By class, change class_name var at top


```r
class_name = 'HtmlRatioTooHighError'
```

Get data


```r
(res <- alerts_by_class(class_name, limit=2000))
```

```
## Source: local data frame [643 x 6]
## 
##          id                      article  val          create_date  source
## 1  13111272 10.1371/journal.pctr.0010015 2058 2014-10-31T08:06:34Z counter
## 2  13073214 10.1371/journal.pctr.0010015 1834 2014-10-29T08:13:59Z counter
## 3  13072880 10.1371/journal.pone.0084669 1647 2014-10-29T08:13:57Z counter
## 4  12630622 10.1371/journal.pone.0084669 1644 2014-10-25T08:33:10Z counter
## 5  12630474 10.1371/journal.pctr.0010015 1619 2014-10-25T08:33:09Z counter
## 6  13111410 10.1371/journal.pntd.0001769  897 2014-10-31T08:06:35Z counter
## 7  13072874 10.1371/journal.pntd.0001769  835 2014-10-29T08:13:57Z counter
## 8  13111036 10.1371/journal.ppat.0020118  799 2014-10-31T08:06:33Z counter
## 9  13111370 10.1371/journal.pmed.1000092  764 2014-10-31T08:06:35Z counter
## 10 12630572 10.1371/journal.pntd.0001769  745 2014-10-25T08:33:09Z counter
## ..      ...                          ...  ...                  ...     ...
## Variables not shown: class (chr)
```

```r
# remove bad data
res <- res %>%
  filter(!is.na(article))
```

Extract top N articles, get DOIs


```r
num_get <- 10
toinspect <- res[1:num_get,] %>% select(-class)
(dois <- toinspect$article)
```

```
##  [1] "10.1371/journal.pctr.0010015" "10.1371/journal.pctr.0010015"
##  [3] "10.1371/journal.pone.0084669" "10.1371/journal.pone.0084669"
##  [5] "10.1371/journal.pctr.0010015" "10.1371/journal.pntd.0001769"
##  [7] "10.1371/journal.pntd.0001769" "10.1371/journal.ppat.0020118"
##  [9] "10.1371/journal.pmed.1000092" "10.1371/journal.pntd.0001769"
```

Browse to an article


```r
browseURL(sprintf("http://alm.plos.org/articles/info:doi/%s", res$article[2]))
```


Get ALM events data and merge alerts data to it


```r
alldf <- add_events_data(toinspect, dois)
```

ggplot elements to reuse


```r
gg <- function(){
  list(geom_line(size = 2, alpha = 0.6),
       geom_vline(aes(xintercept=as.numeric(create_date)), linetype="longdash"),
       ggtitle("HtmlRatioTooHighError - Top ten highest HTML/PDF ratio articles\n"),
       facet_wrap(~ article, ncol = 2, scales = "free"),
       labs(y="", x=""),
       theme_grey(base_size = 14))
}
```

The distribution of html/pdf ratios


```r
res %>%
  ggplot(aes(x=val)) + geom_histogram()
```

![plot of chunk ratio_dist](figure/ratio_dist-1.png) 


Plot html and pdf views, just top 10


```r
alldf %>%
  select(-year, -month, -id, -val, -source, -xml_views, -ratio) %>%
  gather(metric, value, -article, -date, -create_date) %>% 
  ggplot(aes(date, value, color=metric)) + gg()
```

![plot of chunk unnamed-chunk-10](figure/unnamed-chunk-10-1.png) 

The HTML/PDF ratio, just top 10


```r
alldf %>%
  select(-year, -month, -id, -val, -source, -xml_views, -html_views, -pdf_views) %>%
  ggplot(aes(date, ratio)) + gg()
```

![plot of chunk unnamed-chunk-11](figure/unnamed-chunk-11-1.png) 

All ratio lines together


```r
(alldf_alldois <- add_events_data(res, res$article))
```

```
## Source: local data frame [25,588 x 13]
## 
##                         article year month pdf_views html_views xml_views
## 1  10.1371/journal.pntd.0003277 2014     9         4         84         5
## 2  10.1371/journal.pntd.0003277 2014     9         4         84         5
## 3  10.1371/journal.pntd.0003277 2014     9         4         84         5
## 4  10.1371/journal.pntd.0003277 2014    10         7       2815         5
## 5  10.1371/journal.pntd.0003277 2014    10         7       2815         5
## 6  10.1371/journal.pntd.0003277 2014    10         7       2815         5
## 7  10.1371/journal.pntd.0003264 2014     9        11        232         9
## 8  10.1371/journal.pntd.0003264 2014     9        11        232         9
## 9  10.1371/journal.pntd.0003264 2014     9        11        232         9
## 10 10.1371/journal.pntd.0003264 2014    10         4       2706         2
## ..                          ...  ...   ...       ...        ...       ...
## Variables not shown: id (int), val (dbl), create_date (date), source
##   (chr), class (chr), date (date), ratio (dbl)
```

```r
alldf_alldois %>%
  select(article, date, create_date, ratio) %>%
  ggplot(aes(date, log10(ratio), group=article)) + 
    geom_line() +
    labs(y="", x="") +
    theme_grey(base_size = 14)
```

![plot of chunk unnamed-chunk-12](figure/unnamed-chunk-12-1.png) 

Dig in to particular DOIs. This is rather free-form, depends on the metric of interest.


```r
doi1 <- '10.1371/journal.pbio.0040066'
alm_events(doi1, source = "facebook")
alm_ids(doi1, info = "detail")
```

Are the high value offender DOIs associated with other altmetrics, like social media metrics

Get data from `alm` R package


```r
dat <- alm_ids(res$article)
```


```r
datdf <- rbind_all(
  Map(function(x, y) data.frame(article=y, x, stringsAsFactors = FALSE), dat$data, res$article)
)
datdf <- inner_join(datdf, res %>% filter(article %in% res$article) %>% select(article, val))
```

Get html views for each article, join to data


```r
htmls <- datdf %>% filter(.id == "counter") %>% select(article, html) %>% rename(html_views=html)
datdf <- inner_join(datdf, htmls)
```

Select a subset of metrics


```r
datdf <- datdf %>%
  filter(!.id %in% c('citeulike','copernicus','datacite','openedition',
                     'scienceseeker','counter','reddit'))
```

Plot the data


```r
datdf %>% 
  ggplot(aes(x=log10(html_views+1), y=log10(total+1))) + 
    geom_point(aes(size=2)) +
    facet_wrap(~ .id, scales='free') +
    labs(y="", x="") +
    theme_grey(base_size = 18) +
    theme(legend.position="none")
```

![plot of chunk unnamed-chunk-18](figure/unnamed-chunk-18-1.png) 

Are there combinations of metrics that give stronger prediction of the outlier articles


```r
log10_1 <- function(x) log10(x + 1)

analyze <- datdf %>%
  filter(.id %in% c("twitter","facebook","mendeley","wikipedia")) %>%
  select(article, .id, total, html_views) %>%
  spread(.id, total)
```

```
## Error: Duplicate identifiers for rows (56889, 56890, 56893, 56894, 58193, 58194, 58197, 58198), (56891, 56892, 56895, 56896, 58195, 58196, 58199, 58200), (4105, 4106, 4107, 4114, 4115, 4116, 4123, 4124, 4125, 4537, 4538, 4539, 4546, 4547, 4548, 4555, 4556, 4557, 5077, 5078, 5079, 5086, 5087, 5088, 5095, 5096, 5097), (4111, 4112, 4113, 4120, 4121, 4122, 4129, 4130, 4131, 4543, 4544, 4545, 4552, 4553, 4554, 4561, 4562, 4563, 5083, 5084, 5085, 5092, 5093, 5094, 5101, 5102, 5103), (4108, 4109, 4110, 4117, 4118, 4119, 4126, 4127, 4128, 4540, 4541, 4542, 4549, 4550, 4551, 4558, 4559, 4560, 5080, 5081, 5082, 5089, 5090, 5091, 5098, 5099, 5100), (7691, 7692, 7695, 7696, 9515, 9516, 9519, 9520), (7689, 7690, 7693, 7694, 9513, 9514, 9517, 9518), (15829, 15830, 15831, 15838, 15839, 15840, 15847, 15848, 15849, 18529, 18530, 18531, 18538, 18539, 18540, 18547, 18548, 18549, 22400, 22401, 22402, 22409, 22410, 22411, 22418, 22419, 22420), (15832, 15833, 15834, 15841, 15842, 15843, 15850, 15851, 15852, 18532, 18533, 18534, 18541, 18542, 18543, 18550, 18551, 18552, 22403, 22404, 22405, 22412, 22413, 22414, 22421, 22422, 22423), (15835, 15836, 15837, 15844, 15845, 15846, 15853, 15854, 15855, 18535, 18536, 18537, 18544, 18545, 18546, 18553, 18554, 18555, 22406, 22407, 22408, 22415, 22416, 22417, 22424, 22425, 22426), (8623, 8624, 8625, 8632, 8633, 8634, 8641, 8642, 8643, 11527, 11528, 11529, 11536, 11537, 11538, 11545, 11546, 11547, 11743, 11744, 11745, 11752, 11753, 11754, 11761, 11762, 11763), (8617, 8618, 8619, 8626, 8627, 8628, 8635, 8636, 8637, 11521, 11522, 11523, 11530, 11531, 11532, 11539, 11540, 11541, 11737, 11738, 11739, 11746, 11747, 11748, 11755, 11756, 11757), (8620, 8621, 8622, 8629, 8630, 8631, 8638, 8639, 8640, 11524, 11525, 11526, 11533, 11534, 11535, 11542, 11543, 11544, 11740, 11741, 11742, 11749, 11750, 11751, 11758, 11759, 11760), (9297, 9298, 9299, 9306, 9307, 9308, 9315, 9316, 9317, 12385, 12386, 12387, 12394, 12395, 12396, 12403, 12404, 12405, 13853, 13854, 13855, 13862, 13863, 13864, 13871, 13872, 13873), (9300, 9301, 9302, 9309, 9310, 9311, 9318, 9319, 9320, 12388, 12389, 12390, 12397, 12398, 12399, 12406, 12407, 12408, 13856, 13857, 13858, 13865, 13866, 13867, 13874, 13875, 13876), (9303, 9304, 9305, 9312, 9313, 9314, 9321, 9322, 9323, 12391, 12392, 12393, 12400, 12401, 12402, 12409, 12410, 12411, 13859, 13860, 13861, 13868, 13869, 13870, 13877, 13878, 13879), (2917, 2918, 2919, 2926, 2927, 2928, 2935, 2936, 2937, 3241, 3242, 3243, 3250, 3251, 3252, 3259, 3260, 3261, 3457, 3458, 3459, 3466, 3467, 3468, 3475, 3476, 3477), (2923, 2924, 2925, 2932, 2933, 2934, 2941, 2942, 2943, 3247, 3248, 3249, 3256, 3257, 3258, 3265, 3266, 3267, 3463, 3464, 3465, 3472, 3473, 3474, 3481, 3482, 3483), (2920, 2921, 2922, 2929, 2930, 2931, 2938, 2939, 2940, 3244, 3245, 3246, 3253, 3254, 3255, 3262, 3263, 3264, 3460, 3461, 3462, 3469, 3470, 3471, 3478, 3479, 3480), (18208, 18209, 18210, 18217, 18218, 18219, 18226, 18227, 18228, 24216, 24217, 24218, 24225, 24226, 24227, 24234, 24235, 24236, 29208, 29209, 29210, 29217, 29218, 29219, 29226, 29227, 29228), (18211, 18212, 18213, 18220, 18221, 18222, 18229, 18230, 18231, 24219, 24220, 24221, 24228, 24229, 24230, 24237, 24238, 24239, 29211, 29212, 29213, 29220, 29221, 29222, 29229, 29230, 29231), (18205, 18206, 18207, 18214, 18215, 18216, 18223, 18224, 18225, 24213, 24214, 24215, 24222, 24223, 24224, 24231, 24232, 24233, 29205, 29206, 29207, 29214, 29215, 29216, 29223, 29224, 29225), (36601, 36602, 36603, 36610, 36611, 36612, 36619, 36620, 36621, 43261, 43262, 43263, 43270, 43271, 43272, 43279, 43280, 43281, 44809, 44810, 44811, 44818, 44819, 44820, 44827, 44828, 44829), (36604, 36605, 36606, 36613, 36614, 36615, 36622, 36623, 36624, 43264, 43265, 43266, 43273, 43274, 43275, 43282, 43283, 43284, 44812, 44813, 44814, 44821, 44822, 44823, 44830, 44831, 44832), (36607, 36608, 36609, 36616, 36617, 36618, 36625, 36626, 36627, 43267, 43268, 43269, 43276, 43277, 43278, 43285, 43286, 43287, 44815, 44816, 44817, 44824, 44825, 44826, 44833, 44834, 44835), (46439, 46440, 46441, 46448, 46449, 46450, 46457, 46458, 46459, 50651, 50652, 50653, 50660, 50661, 50662, 50669, 50670, 50671, 51115, 51116, 51117, 51124, 51125, 51126, 51133, 51134, 51135), (46436, 46437, 46438, 46445, 46446, 46447, 46454, 46455, 46456, 50648, 50649, 50650, 50657, 50658, 50659, 50666, 50667, 50668, 51112, 51113, 51114, 51121, 51122, 51123, 51130, 51131, 51132), (46433, 46434, 46435, 46442, 46443, 46444, 46451, 46452, 46453, 50645, 50646, 50647, 50654, 50655, 50656, 50663, 50664, 50665, 51109, 51110, 51111, 51118, 51119, 51120, 51127, 51128, 51129), (25433, 25434, 25435, 25442, 25443, 25444, 25451, 25452, 25453, 25865, 25866, 25867, 25874, 25875, 25876, 25883, 25884, 25885, 28849, 28850, 28851, 28858, 28859, 28860, 28867, 28868, 28869), (25436, 25437, 25438, 25445, 25446, 25447, 25454, 25455, 25456, 25868, 25869, 25870, 25877, 25878, 25879, 25886, 25887, 25888, 28852, 28853, 28854, 28861, 28862, 28863, 28870, 28871, 28872), (25439, 25440, 25441, 25448, 25449, 25450, 25457, 25458, 25459, 25871, 25872, 25873, 25880, 25881, 25882, 25889, 25890, 25891, 28855, 28856, 28857, 28864, 28865, 28866, 28873, 28874, 28875), (30069, 30070, 30071, 30078, 30079, 30080, 30087, 30088, 30089, 32197, 32198, 32199, 32206, 32207, 32208, 32215, 32216, 32217, 34485, 34486, 34487, 34494, 34495, 34496, 34503, 34504, 34505), (30072, 30073, 30074, 30081, 30082, 30083, 30090, 30091, 30092, 32200, 32201, 32202, 32209, 32210, 32211, 32218, 32219, 32220, 34488, 34489, 34490, 34497, 34498, 34499, 34506, 34507, 34508), (30075, 30076, 30077, 30084, 30085, 30086, 30093, 30094, 30095, 32203, 32204, 32205, 32212, 32213, 32214, 32221, 32222, 32223, 34491, 34492, 34493, 34500, 34501, 34502, 34509, 34510, 34511), (13427, 13428, 13429, 13436, 13437, 13438, 13445, 13446, 13447, 15619, 15620, 15621, 15628, 15629, 15630, 15637, 15638, 15639, 24003, 24004, 24005, 24012, 24013, 24014, 24021, 24022, 24023), (13421, 13422, 13423, 13430, 13431, 13432, 13439, 13440, 13441, 15613, 15614, 15615, 15622, 15623, 15624, 15631, 15632, 15633, 23997, 23998, 23999, 24006, 24007, 24008, 24015, 24016, 24017), (13424, 13425, 13426, 13433, 13434, 13435, 13442, 13443, 13444, 15616, 15617, 15618, 15625, 15626, 15627, 15634, 15635, 15636, 24000, 24001, 24002, 24009, 24010, 24011, 24018, 24019, 24020), (27196, 27197, 27198, 27205, 27206, 27207, 27214, 27215, 27216, 29856, 29857, 29858, 29865, 29866, 29867, 29874, 29875, 29876, 31052, 31053, 31054, 31061, 31062, 31063, 31070, 31071, 31072), (27193, 27194, 27195, 27202, 27203, 27204, 27211, 27212, 27213, 29853, 29854, 29855, 29862, 29863, 29864, 29871, 29872, 29873, 31049, 31050, 31051, 31058, 31059, 31060, 31067, 31068, 31069), (27199, 27200, 27201, 27208, 27209, 27210, 27217, 27218, 27219, 29859, 29860, 29861, 29868, 29869, 29870, 29877, 29878, 29879, 31055, 31056, 31057, 31064, 31065, 31066, 31073, 31074, 31075), (23456, 23457, 23458, 23465, 23466, 23467, 23474, 23475, 23476, 36496, 36497, 36498, 36505, 36506, 36507, 36514, 36515, 36516, 39224, 39225, 39226, 39233, 39234, 39235, 39242, 39243, 39244), (23459, 23460, 23461, 23468, 23469, 23470, 23477, 23478, 23479, 36499, 36500, 36501, 36508, 36509, 36510, 36517, 36518, 36519, 39227, 39228, 39229, 39236, 39237, 39238, 39245, 39246, 39247), (23453, 23454, 23455, 23462, 23463, 23464, 23471, 23472, 23473, 36493, 36494, 36495, 36502, 36503, 36504, 36511, 36512, 36513, 39221, 39222, 39223, 39230, 39231, 39232, 39239, 39240, 39241), (47840, 47841, 47842, 47849, 47850, 47851, 47858, 47859, 47860, 49834, 49835, 49836, 49843, 49844, 49845, 49852, 49853, 49854, 53360, 53361, 53362, 53369, 53370, 53371, 53378, 53379, 53380), (47837, 47838, 47839, 47846, 47847, 47848, 47855, 47856, 47857, 49831, 49832, 49833, 49840, 49841, 49842, 49849, 49850, 49851, 53357, 53358, 53359, 53366, 53367, 53368, 53375, 53376, 53377), (47843, 47844, 47845, 47852, 47853, 47854, 47861, 47862, 47863, 49837, 49838, 49839, 49846, 49847, 49848, 49855, 49856, 49857, 53363, 53364, 53365, 53372, 53373, 53374, 53381, 53382, 53383), (23024, 23025, 23026, 23033, 23034, 23035, 23042, 23043, 23044, 28524, 28525, 28526, 28533, 28534, 28535, 28542, 28543, 28544, 30292, 302
```

```r
analyze$html_views <- log10_1(analyze$html_views)
```

```
## Error in log10_1(analyze$html_views): object 'analyze' not found
```

```r
analyze$facebook <- log10_1(analyze$facebook)
```

```
## Error in log10_1(analyze$facebook): object 'analyze' not found
```

```r
analyze$mendeley <- log10_1(analyze$mendeley)
```

```
## Error in log10_1(analyze$mendeley): object 'analyze' not found
```

```r
analyze$twitter <- log10_1(analyze$twitter)
```

```
## Error in log10_1(analyze$twitter): object 'analyze' not found
```

```r
analyze$wikipedia <- log10_1(analyze$wikipedia)
```

```
## Error in log10_1(analyze$wikipedia): object 'analyze' not found
```

```r
analyze %>%
  lm(html_views ~ facebook + mendeley + twitter + wikipedia, data = .) %>%
  summary
```

```
## Error in eval(expr, envir, enclos): object 'analyze' not found
```



Detect spikes/patterns in signals through time


```r
'not done yet...'
```

> based on the above work, identify which articles are deserving of further inspection/flagging - perhaps need to look at log files for IP addresses, etc.
